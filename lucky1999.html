<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<script src="./config.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>抽籤執行系統</title>
<style>
:root {
  --cols:4ch 12ch auto 4em 1em;
  --bg:#0f172a;
  --fg:#e2e8f0;
  --accent:#10b981;
  --muted:#334155;
}
html,body{font-family:-apple-system,BlinkMacSystemFont,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;background:var(--bg);color:var(--fg);height:100%;max-width: 480px; margin: 0 auto; }
body{display:flex;flex-direction:column;overflow:hidden;}

.top{
  display:flex; align-items:center; justify-content:space-between;
  gap:8px; padding:6px 12px; height:45px; box-sizing:border-box;
  background:#1e293b; border-bottom:1px solid #334155;

  /* 防自動放大與換行 */
  text-size-adjust:none; -webkit-text-size-adjust:none; -moz-text-size-adjust:none;
  white-space:nowrap; overflow:hidden;

  /* 字型鎖定 */
  font-size:14px; line-height:1.2; letter-spacing:.02em;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
}

/* 子項統一行為 + 修復 Firefox 溢出與垂直不齊 */
.top > *{
  flex:0 0 auto; font-size:inherit; color:#e5e7eb;
  display:flex; align-items:center; min-width:0;
}

/* 狀態燈 */
.top .status{ gap:6px; }
.top .dot{ width:10px; height:10px; border-radius:50%; background:#475569; }
.top .dot.ok{ background:#22c55e; } .top .dot.err{ background:#ef4444; }

/* 時鐘 */
.top .clock{ font-family:monospace; font-size:12px; line-height:1; color:#94a3b8; }

/* 控制項（btn + sel 共用基底） */
.top .btn, .top .sel{
  display:inline-flex; align-items:center; justify-content:center;
  height:28px; padding:0 10px; line-height:1; border-radius:8px;
  border:1px solid #334155; background:#1f2937; color:#e5e7eb;
  transition:background .15s ease, box-shadow .15s ease, border-color .15s ease;
}
.top .btn:hover{ background:#334155; }
.select-bar{ position:relative; display:flex; align-items:center; }
.select-bar::after{
  content:""; position:absolute; right:10px; top:50%; transform:translateY(-50%);
  width:0; height:0; pointer-events:none;
  border-left:6px solid transparent; border-right:6px solid transparent; border-top:8px solid #FFD700;
}

/* 下拉：常態高亮 + 移除原生箭頭 */
.sel{
  appearance:none; -webkit-appearance:none; -moz-appearance:none;
  border:2px solid #00fff7; border-radius:8px;
  height:28px; padding:0 28px 0 10px;
  background:#1e3a8a; color:#fff;
  box-shadow:0 0 8px #00fff7;
  line-height:1; display:inline-flex; align-items:center;
}
.sel::-ms-expand{ display:none; }
.sel:focus, .sel:focus-visible{
  outline:none;
  border-color:#00fff7;
  box-shadow:0 0 12px #00fff7, 0 0 2px #00fff7 inset;
}

/* 小螢幕：只收緊間距與尺寸，字級不變 */
@media (max-width:480px){
  .top{ gap:6px; padding:6px 8px; }
  .top .btn, .top .sel{ height:26px; padding:0 8px; }
  .top .sel{ padding-right:22px; background-size:9px 5px; max-width:260px; }
}


.main{flex:1 1 auto;display:flex;flex-direction:column;overflow-y:auto;padding:25px 10px 12px 10px;box-sizing:border-box;}
.rows { display:flex; flex-direction: column; box-sizing: border-box; gap: 2px; width: 90%; margin: 0 auto; }
#rows{
  width:90%;
  min-height:480px;
  background-position:center;
  background-repeat:no-repeat;
  background-size:contain;
  border-radius:8px;
  opacity:1;
  transition:background-image 1s ease-in-out,opacity 1s ease;
  padding:0px;
  background-clip:content-box; }
.group{border-bottom:1px solid #334155;margin-top:8px;padding-bottom:4px }
.row{border-bottom:1px solid #1e293b; }
.group, .row {
  display:grid; gap: 6px; padding:4px 6px;
  grid-template-columns:4ch 10ch auto 4em 1em; }
.group >:nth-child(4), .row >:nth-child(4) {text-align: center; }
.row.selected {background-color: rgba(56,189,248,0.3); }
.sep{height:8px;}
.mask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,.85);color:#fff;font-size:1.2em;z-index:10;}
.mask.show{display:flex;}
.status{display:flex;align-items:center;gap:6px;font-size:.9em}
.dot{width:10px;height:10px;border-radius:50%;background:#64748b}
.dot.ok{background:#10b981}
.dot.err{background:#ef4444}

.group.A {
  color: #38bdf8;
  background: #38bdf820;}
.row.A {
  color: #7dd3fc;}
.group.B {
  color: #f87171;
  background: #f8717120;}
.row.B {
  color: #fdba74;}
</style>
</head>
<body>
<div class="top">
  <!-- 狀態燈 -->
  <div class="status" id="gasStatus">
    <span class="dot" id="gasDot"></span>
    <span id="gasText">GAS</span>
  </div>

  <!-- 抽籤按鈕 -->
  <div class="btns">
    <button class="btn" id="btnDraw">抽　籤</button></div>

  <!-- 時間顯示 -->
  <div class="clock" id="nowTime">--/-- --:--:--</div>

  <!-- 日期選單 -->
  <div class="select-bar">
    <select id="daySel" class="sel"></select>  </div>

  <!-- 讀表按鈕 -->
  <div class="btns">
    <button class="btn" id="btnRead">讀　表</button>  </div>
</div>

<div class="main">
  <div id="rows" class="rows"></div>
</div>

<div id="mask" class="mask">處理中…</div>

<audio id="bgm" src="./mus/clock03.mp3" preload="auto"></audio>
<script>
// Prontera.mp3
bgm.src = './mus/Detektiv.mp3';
bgm.load();
/* ===== 綁定 ===== */
const mask=document.getElementById('mask');
const el = document.getElementById('nowTime');
const rowsEl = document.getElementById('rows');

/* ===== 日期選單 ===== */
const daySel=document.getElementById('daySel');
const base = ymdToSerial(now);
const DAYS = Array.from({ length:7 }, (_, k) => {
  const s = base + k
  const ymd = serialToYMD(s);
  return {
    ymd,
    serial: s,
    label:ymd.slice(5)
  };
});
daySel.innerHTML=DAYS.map((x,i)=>`<option value="${x.serial}"${i===0?' selected':''}>${x.label}</option>`).join('');

let currS = null;
function currentS() {
  return Number(daySel.value); }

/* ===== 狀態顯示 ===== */
const gasDot  = document.getElementById('gasDot');
const gasText = document.getElementById('gasText');

function setGas(status){
  if(!gasDot || !gasText) return;
  gasDot.className = 'dot' + (status==='GAS' ? ' ok' : status==='ng' ? ' err' : '');
  gasText.textContent = status;
}
setGas('n/a');
async function pingGas(){
  try{
    const res = await fetch(api_url + '?target=ping', { cache:'no-store' });
    const j = await res.json();
    setGas(j.status === 'ok' ? 'GAS' : 'GG');
  }catch(e){
    setGas('GG');
  }
}

/* ===== 資料解析 ===== */
function parseLuckyData(data){
  if(!data||data.status!=='ok')return[];
  const F=Object.fromEntries(data.fields.map((k,i)=>[k,i]));
  return data.values.map(a=>({ date:a[F.date],id:a[F.id],shift:a[F.shift],dN:a[F.dN],name:a[F.name],tier:a[F.lucky]
  }));
}

/* ===== 資料渲染 ===== */
function renderResponse(j){
  const list = parseLuckyData(j);
  const rows = list.filter(r =>
  Number(r.date) === currS && ['A','B'].includes(r.shift.toUpperCase()) && Number(r.tier) > 0 && Number(r.tier) < 3000).sort((a, b) => Number(a.tier) - Number(b.tier));

  const A=[], B=[];
  rows.forEach(r => (String(r.shift).toUpperCase()==='A' ? A : B).push(r));

  BgCycle('stop'); // 背景圖關閉 
  rowsEl.innerHTML = '';
  const frag = document.createDocumentFragment();
  frag.appendChild(group('_A','a'));
  if (A.length===0) frag.appendChild(empty());
  let seqA=1;
  A.forEach(r => frag.appendChild(line(seqA++, r.id, r.name, r.dN,'a')));
  frag.appendChild(sep());
  frag.appendChild(group('_B','b'));
  if (B.length===0) frag.appendChild(empty());
  let seqB=1;
  B.forEach(r => frag.appendChild(line(seqB++, r.id, r.name, r.dN,'b')));

  rowsEl.appendChild(frag);
  function cell(t){ const d=document.createElement('div'); d.textContent=t; return d; }
function group(t,cls){
  const g = document.createElement('div');
  g.className = 'group ' + cls.toUpperCase();
  g.append(cell(t),cell('工　號'),cell('姓　　名'),cell('假　別'),cell('　'));
  return g;
}
  function sep(){ const s=document.createElement('div'); s.className='sep'; s.style.gridColumn='1/-1'; return s; }
  function empty(){ const r=document.createElement('div'); r.className='row'; r.append(cell('—'),cell('　'),cell('查無此人'),cell('　'),cell('　')); return r; }
  function line(n,id,name,dn,cls){
    const r=document.createElement('div'); 
    r.className = 'row ' + cls.toUpperCase();
    r.append(cell(n), cell(id), cell(name), cell(dn),cell('　')) ; return r;
  }
}

/* ===== 點擊高亮 ===== */
document.addEventListener('click', e=>{
  const row = e.target.closest('.row');
  if (!row) return; document.querySelectorAll('.row.selected').forEach(r=>r.classList.remove('selected'));
  row.classList.add('selected');
});

/* ===== 通訊 ===== */
async function reloadData(){
  showMask('讀取中…');
  currS = currentS();
  try{
    const p=new URLSearchParams();
    p.append('action','list_recent');
    p.append('dateSerial',currS);
    const r=await fetch(api_url,{method:'POST',body:p});
    const j=await r.json();
    renderResponse(j);
  }catch(e){showMask('讀取失敗');setTimeout(hideMask,1500);}
  finally{hideMask();}
}

async function draw(){
  currS = currentS();
  const uid = localStorage.getItem('user_id3');
  if (!uid) {
    window.open('verify.html', '_blank');
    return;
  }
  showMask('抽籤中…');
  try {
    const pwd = localStorage.getItem('user_ps3');
    const p = new URLSearchParams();
    p.append('action','lucky');
    p.append('uid', uid);
    p.append('swd', pwd);
    p.append('dateSerial', currS);

    const r = await fetch(api_url, { method:'POST', body:p });
    const j = await r.json();

    if (j && j.status === 'ok') {
      renderResponse(j);
      showMask('抽籤完成');
    } else {
      showMask('❌ 抽籤失敗：' + (j.msg ||'未知錯誤'));
    }
    setTimeout(hideMask, 1200);
  } catch(e) {
    showMask('❌ 連線或解析失敗');
    setTimeout(hideMask, 1500);
  }
}

/* ===== 即時時間顯示 ===== */
function tickN() {
el.textContent=now.slice(5); }

/* ===== 遮罩控制 ===== */
function showMask(t){mask.textContent=t;mask.classList.add('show'); }
function hideMask(){mask.classList.remove('show');}


// === 背景圖片清單 ===
const IMG_BASE = "https://cdn.imgchest.com/files/";
const BG_LIST = [
  "b9c23f4e91c6.jpg",
  "31e59810dff0.jpg",
  "73e52af2314c.jpg",
  "45cea37d2076.jpg",
  "2e6887215309.jpg",
  "35864c4b541c.jpg"
];
const BG_URLS = BG_LIST.map(name => `${IMG_BASE}${name}`);

let prevIdx = -1;
const bg_n = BG_URLS.length;
function cycleBG() {
  let idx;
  do {
    idx = Math.floor(Math.random() * bg_n);
} while (idx === prevIdx);
  prevIdx = idx;
  rowsEl.style.backgroundImage = `url('${BG_URLS[idx]}')`;
}
// 啟動背景循環（例如每 15 秒換一張）
let bgTimer = null;
function BgCycle(state) {
  if (state === 'stop') {
    clearInterval(bgTimer);
    rowsEl.style.backgroundImage = 'none';
  } 
  else if (state === 'start') {
    cycleBG();
    bgTimer = setInterval(cycleBG, 15000);
  }
}

/* ===== 初始化 ===== */
  tickN();
    setInterval(tickN,1000);
  pingGas();
    setInterval(pingGas, 45000);
  BgCycle('start');

daySel.addEventListener('change', () => {
  playSFX(2);
});

document.getElementById('btnRead').onclick=reloadData;
document.getElementById('btnDraw').onclick=draw;
// document.addEventListener('DOMContentLoaded', reloadData);
</script>
</body>
</html>