<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<script src="./config.js"></script>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>D2｜名單瀏覽</title>
<style>
:root{--bg:#0b1220;--panel:#0f172acc;--text:#e5e7eb;--sub:#94a3b8;--line:#1f2937;--accent:#22d3ee}
html,body{height:100%;margin:0;background:linear-gradient(135deg,#0b1023,#101a36 45%,#0b1a23);color:var(--text);font-family:system-ui,Inter,"PingFang TC","Microsoft JhengHei",sans-serif}
.container{min-height:100vh;display:flex;flex-direction:column;align-items:center;gap:10px;padding:12px}
h1{margin:6px 0 8px;font-size:18px;letter-spacing:.08em;color:var(--accent);text-align:center}
.panel{width:min(900px,94vw);background:var(--panel);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.35);padding:10px}
.section{margin:8px 0 10px}
.sect-hd{display:flex;justify-content:space-between;align-items:center;margin:2px 0 6px}
.sect-title{font-size:14px;color:#93c5fd}
.count{font-size:12px;color:#a7f3d0}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.card{background:#0b1324;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.card h3{margin:0;padding:6px 8px;font-size:13px;color:#c7d2fe;border-bottom:1px solid var(--line);text-align:center}
//.table{max-height:48vh;overflow:auto}
//.table { overflow: visible; }
.table{ overflow-y: visible;
max-height:unset; }
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px 10px;border-bottom:1px dashed #1f2a44;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
th{position:sticky;top:0;background:#0b1324;color:var(--sub)}
.empty{padding:14px;color:var(--sub);text-align:center}
.spinner{border:4px solid rgba(255,255,255,.2);border-top:4px solid var(--accent);border-radius:50%;width:42px;height:42px;animation:spin 1s linear infinite;margin:40px auto}
@keyframes spin{to{transform:rotate(360deg)}}
.hidden{display:none}
.btn{appearance:none;border:0;border-radius:10px;background:linear-gradient(180deg,#0ea5e9,#0369a1);padding:8px 18px;color:#fff;font-weight:700;letter-spacing:.06em;cursor:pointer;transition:transform .12s}
.btn:hover{transform:translateY(-1px)}.btn:active{transform:translateY(1px)}
.updated{ font-size:12px; color:var(--sub)}

.toolbar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-top:12px;
}
</style>
</head>
<body>
<div class="container">
  <h1>D2 大夜班跨加｜名單瀏覽</h1>

  <div id="loading" class="spinner"></div>

  <section id="box" class="panel hidden">
    <!-- 動態塞入兩大筆（依日期） -->
    <div id="sections"></div>
  </section>

  <div class="toolbar">
    <button class="btn" id="reload">重新整理</button>
    <div class="updated">更新：<span id="ut">--/-- --:--</span></div>
  </div>

<script>
/* ===== POST：URLSearchParams ===== */
async function fetchList(){
  const params = new URLSearchParams();
  params.append('action', 'list_recent');
  const res = await fetch(api_url, {
    method: 'POST',
    body: params,
    cache: 'no-store'
  });

  const j = await res.json();
  if (!j || j.status !== 'ok' || !Array.isArray(j.fields) || !Array.isArray(j.values))
    return { rows: [] };

  const F = Object.fromEntries(j.fields.map((k, i) => [k, i]));
  const rows = j.values.map(a => ({
    key: a[F.key],
    date: Number(a[F.date]),
    id: a[F.id],
    shift: a[F.shift],
    dN: a[F.dN],
    name: a[F.name]
  }));
  return { rows };
}

function splitDays(rows){
  const N = 8;
  const minSerial = ymdToSerial(now);
  const buckets = new Map();

  for (const r of rows) {
    const d = Number(r.date) || 0;
    if (d < minSerial) continue;
    if (!buckets.has(d)) buckets.set(d, []);
    buckets.get(d).push(r);
}

  const dates = [...buckets.keys()].sort((a, b) => a - b).slice(0, N);

  const sortRow = (a,b)=>{
    const d = String(b.dN||'').localeCompare(String(a.dN||''));
    if(d!==0) return d;
    return String(a.id||'').localeCompare(String(b.id||''), 'en', {numeric:true, sensitivity:'base'});
  };

  return dates.map(dSer=>{
    const subset = buckets.get(dSer).slice().sort(sortRow);
    return {
      date: dSer,
      A: subset.filter(x=>String(x.shift).toUpperCase()==='A').map(x=>({id:x.id,name:/^[A-Za-z0-9]+$/.test(x.name) ? '' : x.name,dN:x.dN})),
      B: subset.filter(x=>String(x.shift).toUpperCase()==='B').map(x=>({id:x.id,name:/^[A-Za-z0-9]+$/.test(x.name) ? '' : x.name,dN:x.dN}))
    };
  });
}

/* ===== 渲染：每日 sectionA/B 卡片 ===== */
function render(groups){
  const root = document.getElementById('sections');
  if (!groups || !groups.length){
    root.innerHTML = `<div class="empty">目前無資料</div>`;
    return;
  }

  root.innerHTML = groups.map(g => sectionHTML(g)).join('');

  function sectionHTML(g){
    const title = `日期：${serialToMD(g.date)}`;
    const total = (g.A?.length||0) + (g.B?.length||0);
    return `
      <div class="section">
        <div class="sect-hd">
          <div class="sect-title">${title}</div>
          <div class="count">筆數：${total}</div>
        </div>
        <div class="grid">
          ${card('A 班', g.A)}
          ${card('B 班', g.B)}
        </div>
      </div>`;
  }
  function card(h3, list){
    if (!list || !list.length){
      return `<div class="card"><div class="empty">本日無資料</div></div>`;
    }
    const rows = list.map(r => `<tr><td>${esc(r.id)}</td><td>${esc(r.name)}</td><td>${esc(r.dN)}</td></tr>`).join('');
    return `
      <div class="card">

        <div class="table">
          <table>

            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>`;
  }
  function esc(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
}

/* ===== 流程 ===== */
async function loadData(){
  document.getElementById('loading').classList.remove('hidden');
  document.getElementById('box').classList.add('hidden');

  let rows = [];
  try {
    const { rows: r } = await fetchList();
    rows = r;
  } catch (_) {
    rows = [];
  }

  const groups = splitDays(rows);
  render(groups);
  document.getElementById('loading').classList.add('hidden');
  document.getElementById('box').classList.remove('hidden');

document.getElementById('ut').textContent=now
}

document.getElementById('reload').addEventListener('click',()=>loadData());
loadData();
</script>
</body>
</html>