<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<script src="./config.js"></script>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>D2大夜班跨加報名系統</title>
<style>
:root{
  --footer-h: 48px;
  --bg:#0b1220; --panel:#1a2333cc; --glass:#1f2937aa; --text:#e5e7eb; --sub:#94a3b8;
  --accent:#22d3ee;
}
html,body{ padding-bottom:var(--footer-h); margin:0;height:100%;background:radial-gradient(circle at top,#0b1725,#060b15 80%); color:var(--text);font-family:system-ui,-apple-system,"PingFang TC","Microsoft JhengHei",sans-serif; overflow-x:hidden;box-sizing:border-box; }
*,*::before,*::after{box-sizing:inherit}
header{ text-align:center;padding:16px 0;font-size:20px;font-weight:700;letter-spacing:.08em; background:linear-gradient(90deg,#0d1b2a,#1b263b);box-shadow:0 2px 10px rgba(0,0,0,.4); }
main{padding:8px 0 0;overflow:visible;
display:block; height:100%; }
  @supports (height:100dvh)
{ .main{min-height:100dvh;} }
.container{width:80%;max-width:480px;min-width:240px;margin:0 auto;}
.panel{ width:100%;background:var(--panel);border-radius:20px;padding:20px;margin:0;
  box-shadow:0 0 25px rgba(0,0,0,.4),inset 0 0 15px rgba(255,255,255,.06);backdrop-filter:blur(8px);
}
.input{display:flex;justify-content:center;margin:7px 0;}
.in{ width:200px;height:44px;border-radius:10px;border:1px solid #334155;background:#0f172a; color:var(--text);text-align:center;font-size:18px;letter-spacing:.2em;text-transform:uppercase; }
.in:focus{outline:2px solid var(--accent);}
/* background:var(--glass);border:1px solid #1f2937; */
.mmdd {
  text-align: center;
  padding: 6px 14px;
  border-radius: 999px;
  font-weight: 700;
  margin: 3px auto;
  width: max-content;
  background: inherit;
  border: none;
  box-shadow: none !important;
  text-shadow: none !important;
  filter: none !important;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}
.mmddsel{
  appearance:none;
  -webkit-appearance:none;
  -moz-appearance:none;
  background:var(--glass);
  border:1px solid #1f2937;
  padding:6px 10px;
  border-radius:999px;
  font-weight:700;
  margin:6px auto;
  color:inherit;
  text-align:center;
  min-width:99px;
  box-shadow:var(--shadow);
  background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 10 6'><path fill='%23ffd700' d='M0 0l5 6 5-6z'/></svg>");
  background-repeat:no-repeat;
  background-position:right 8px center;
  background-size:10px 6px;
  padding-right:20px;
  cursor:pointer;
} 
/* .mmddsel:focus{outline:2px solid var(--accent)} */
.mmddsel:hover,.mmddsel:focus { outline:none; 
  border:2px solid #00fff7;
  box-shadow:0 0 8px #00fff7; }
.group{margin-top:16px;text-align:center;}
.gtitle{font-size:12px;color:var(--sub);margin-bottom:1px;}
.btnrow{display:grid;column-gap: 16px; row-gap: 40px; }
.btnrow.two{grid-template-columns:repeat(2,minmax(0,1fr));}
.btnrow.three{grid-template-columns:repeat(3,minmax(0,1fr));}
.btn{
  height:44px;
  border-radius:12px;
  border:1px solid #334155; background:linear-gradient(180deg,#1e293b,#0f172a);
  color:var(--text);
  font-weight:600;
  letter-spacing:.05em;
  cursor:pointer;
  transition:all .15s ease; }
.btn:hover{ background:linear-gradient(180deg,#334155,#1e293b);
  transform:translateY(-1px); }
.btn.sel{
  outline:2px solid var(--accent);
  box-shadow:0 0 10px rgba(34,211,238,.4);}
.btn.red{color:#ef4444;}
.btn.black{color:#e5e7eb;}
.btn.primary{ background:linear-gradient(180deg,#0ea5e9,#0369a1);
  border:1px solid #0891b2;
  border-radius:14px;
  padding:10px 32px;
  color:#fff;
  font-weight:700;
  letter-spacing:.08em;
  box-shadow:0 4px 12px rgba(0,0,0,.4);
  transition:all .2s ease; }
.btn.primary:hover{ background:linear-gradient(180deg,#38bdf8,#0ea5e9);
  transform:translateY(-1px);
  box-shadow:0 6px 14px rgba(0,0,0,.45); }
.btn.primary:active{
  transform:translateY(1px);
  box-shadow:0 2px 6px rgba(0,0,0,.5) inset; filter:brightness(.95); }

/* 草稿B（主體下方，無外框，置中） */
.draftB{
  width:100%;max-width:640px;margin:6px auto 0;background:rgba(15,23,42,.8); border:none;border-radius:12px;padding:8px 6px;text-align:center;box-shadow:none; }
.line{padding:6px 8px;border-bottom:1px dashed #334155;font-size:13px;}
.line:last-child{border-bottom:0;}
.draftB .ok1 { color: #ea0000; }
.draftB .ok2 { color: #00db00; }
.draftB .xd  { color: #ffd700; }
.draftB .ng  { color: #00ffff; }
#draftB .line {
  font-family: monospace;
  white-space: pre;
}

/* 底部狀態列 */
.footerbar{ height:var(--footer-h);position:fixed;left:0;bottom:0;width:100%;display:flex;justify-content:space-between;align-items:center;
  padding:6px 12px;background:rgba(17,24,39,.7);border-top:1px solid #1f2937;backdrop-filter:blur(8px);
  font-size:12px;color:var(--sub); }
.sitem{display:flex;align-items:center;gap:6px; }
.dot{width:10px;height:10px;border-radius:50%;background:#475569;}
.dot.ok{background:#22c55e;} .dot.bad{background:#ef4444; }
.ver{color:#60a5fa;font-weight:700; }
.clock{font-variant-numeric:tabular-nums;color:var(--accent); }
/* 上傳中 */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:999;}
.spinner{width:50px;height:50px;border-radius:50%;border:4px solid rgba(255,255,255,.3);border-top-color:var(--accent);animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
#toast{
  position:fixed; left:50%; bottom:40%; transform:translateX(-50%) translateY(8px);
  padding:10px 16px; border-radius:10px; background:#0b1324cc; color:#e5e7eb;
  border:1px solid #334155; box-shadow:0 6px 20px rgba(0,0,0,.35);
  font-weight:700; letter-spacing:.04em; z-index:9999;
  opacity:0; transition:opacity .2s ease, transform .2s ease; pointer-events:none;
}
#toast.show{ opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>
<header>D2大夜班跨加報名系統</header>
<main>
  <div class="container">
    <section class="panel">
      <div class="input">
        <input id="code" class="in" placeholder="輸入＀５碼＀ＩＤ" maxlength="5" autocomplete="one-time-code" inputmode="latin">
      </div>
      <div id="mmdd" class="mmdd">報　名　<select id="selDate" class="mmddsel"></select>　跨加</div>
      <div class="group">
        <div class="btnrow two">
          <button class="btn red" data-a="假日">♦ 假 日 ♦</button>
          <button class="btn black" data-a="平日">♣ 平 日 ♣</button>
        </div>
      </div>

      <div class="group">
        <div class="btnrow three">
          <button class="btn" data-b="A">日班 | A</button>
          <button class="btn" data-b="N">取　消</button>
          <button class="btn" data-b="B">小夜 | B</button>
        </div>
      </div>

      <div class="group">
        <div class="gtitle">　</div>
        <button id="sendBtn" class="btn primary" disabled>送出</button>
      </div>
    </section>

    <!-- 草稿B緊貼主體 -->
    <div class="draftB" id="draftBoxB">
      <div id="draftB"></div>
    </div>
  </div>
</main>

<!-- 底部狀態列：左=三燈 | 中=版本 | 右=時鐘 -->
<div class="footerbar">
  <div style="display:flex;gap:12px;align-items:center;">
    <div class="sitem"><span class="dot" id="dotGas"></span>GAS</div>
    <div class="sitem"><span class="dot" id="dotSs"></span>wb</div>
    <div class="sitem"><span class="dot" id="dotSh"></span>sh1</div>
  </div>
  <div class="ver">版本：v1.5.7</div>
  <div class="clock" id="clock">--/-- --:--:--</div></div>

  <div class="overlay" id="overlay"><div class="spinner"></div></div>

  <div id="toast"></div>

  <audio id="bgm" src="./mus/clock03.mp3" preload="auto"></audio>
<script>
  bgm.src = './mus/login1.mp3';
  bgm.load();
  let lock_st = 0, selA='平日', selB='N';
  const DAYS = [];
  const cuton =  360; // 換日時間
  const cutoff = 130; // 超時時間

const box  = document.getElementById('draftBoxB');
const list = document.getElementById('draftB');
const sel = document.getElementById('selDate');
const el=document.getElementById('code');
const tn=document.getElementById('clock');
const en=document.getElementById('toast');
const sendBtn = document.getElementById('sendBtn');
const aBtns = Array.from(document.querySelectorAll('[data-a]'));
const bBtns = Array.from(document.querySelectorAll('[data-b]'));

/* ===== 草稿A ===== */
const DRAFTA_KEY='d2_draft_a_v1';
function saveA(id){localStorage.setItem(DRAFTA_KEY,id);}
function loadA(){return localStorage.getItem(DRAFTA_KEY)||'';}

/* ===== 草稿B ===== */
const DRAFTB_KEY='d2_draft_b_v3';
let DRAFTB = JSON.parse(localStorage.getItem(DRAFTB_KEY) || '[]');

function saveB(item){
  DRAFTB.unshift(item);
  DRAFTB = DRAFTB.slice(0, 15);
  localStorage.setItem(DRAFTB_KEY, JSON.stringify(DRAFTB));
  renderB(DRAFTB);
}

function renderB(arr) {
  const data = arr;
  if (!data.length){ box.style.display='none'; list.innerHTML=''; return; }
  box.style.display='block';
  list.innerHTML = data.map(x =>
    `<div class="line ${x.flag}">${x.ts} ${x.id} ${x.a} ${x.b} ${x.msg}</div>`
  ).join('');
}

/* ===== 狀態燈（GET） ===== */
async function probeStatus(){
  const gas=document.getElementById('dotGas'),ss=document.getElementById('dotSs'),sh=document.getElementById('dotSh');
  const set=(el,c)=>{el.classList.remove('ok','bad');el.classList.add(c);};
  try{
    const r=await fetch(api_url+'?target=1',{method:'GET',cache:'no-store'});
    set(gas,r.ok?'ok':'bad');
    const j=await r.json().catch(()=>null);
    if(j&&j.fileExists)set(ss,'ok');
    if(j&&j.sheetExists)set(sh,'ok');
  }catch(_){set(gas,'bad');}
}

function startClock(){ tn.textContent=now }

/* ===== 傳送 ===== */
function showOverlay(on){document.getElementById('overlay').style.display=on?'flex':'none';}
function submitData(p){
  const params=new URLSearchParams();
  params.append('action','submit');
  params.append('uid',p.uid);
  params.append('key',p.key);
  params.append('date',p.date);
  params.append('shift',p.shift);
  params.append('id',p.id);
  params.append('dN',p.dN);
  return fetch(api_url,{method:'POST',body:params,cache:'no-store'})
    .then(r=>r.text()).then(t=>{try{return JSON.parse(t);}catch(_){return{status:'parse_failed',raw:t};}});
}

/* ===== 送出動作 ===== */
async function send(){
  const curr = currentS();
  const uid = localStorage.getItem('user_id');
  if (!uid) {
    window.open('verify.html', '_blank');
    return; }
  const id = el.value.trim().toUpperCase();
  if(!/^[A-Z0-9]{5}$/.test(id)){
    el.focus();
    return;
  }
  const payload = { id, date: curr.s, key: `${curr.s}|${id}`, shift: selB, dN: selA, uid: uid };
  showOverlay(true);
  let ok=false,res;
  try{ res=await submitData(payload); ok=res&&res.status==='ok'; }
  catch(_){ ok=false; }
  showOverlay(false);
  let ts= now.slice(5, 16);

  const status = ok ? 'ok':'ng';
  const resultText = ok ? '成功' : '失敗';
  const flag = !ok
    ? 'ng'
    : selB === 'N'
      ? 'xd'
      : selA === '假日'
        ? 'ok1'
        : selA === '平日'
          ? 'ok2'
          : 'ok';
  //const bDisp = selB === 'N' ? '_' : selB;
  //  const aDisp = `${curr.b} - ${selB === 'N' ? '取消' : selA}`;

  const bDisp = selB === 'N' ? '\u00A0' : selB;
  const aDisp = `${curr.b} ${selB === 'N' ? '取消' : selA}`;
  saveB({ ts, id, a: aDisp, b: bDisp, msg:  `${resultText}`, flag });
  playSFX(0);
  toast(ok ? `　${aDisp}　` : '送出失敗')
}

function currentS() {
  const idx = sel.selectedIndex;
  const s = sel.options[idx].value;
  const b = sel.options[idx].textContent;
  return { s , b };
}

function checkCutoff(){
  if (mins >= cuton && lock_st === 1) {
    fillDateSelect();
  }
  if (mins > cutoff && mins < cuton && lock_st === 0) {
    if (sel.selectedIndex === 0)
    sel.selectedIndex = 1;
    sel.options[0].disabled = true;
    sel.focus();
    lock_st = 1;
  }
}

function toast(msg, duration = 2200){
  if(!en) return;
  en.textContent = msg;
  en.classList.add('show');
  clearTimeout(en._t);
  en._t = setTimeout(()=>en.classList.remove('show'), duration);
}

/* ===== 輸入與選項 ===== */
function onElEvent(e) {
  if (e.type === 'focus') return (el.value = '');
  const v = el.value.replace(/[^A-Za-z0-9]/g, '').toUpperCase().slice(0, 5);
  el.value = v;
  if (v.length === 5) saveA(v);
}

function setSel(btns,val,attr){
  btns.forEach(b=>{const on=b.dataset[attr]===val;b.classList.toggle('sel',on);b.setAttribute('aria-pressed',on?'true':'false');});
}

/* ===== 產生 7 天清單並灌入下拉 ===== */
function fillDateSelect(){
  let base = ymdToSerial(now);
  if (mins >= cuton) { base += 1; }
  DAYS.length = 0;
  for (let k = 0; k < 7; k++) {
    const s   = base + k;
    const ymd = serialToYMD(s);
    DAYS.push({ ymd, serial: s, label: ymd.slice(5) });
  }
  sel.innerHTML = DAYS
    .map((x,i)=>`<option value="${x.serial}" ${i===0?'selected':''}>${x.label}</option>`)
    .join('');
  sel.selectedIndex = 0;
  sel.focus();
  lock_st = 0;
}

function onA(e){ selA = e.currentTarget.dataset.a; setSel(aBtns, selA, 'a'); enableSend(); }

function onB(e){ selB = e.currentTarget.dataset.b; setSel(bBtns, selB, 'b'); enableSend(); }

function enableSend(){ 
document.getElementById('sendBtn').disabled=!(selA&&selB); }


el.addEventListener('focus', onElEvent);
el.addEventListener('input', onElEvent);

aBtns.forEach(x => 
  x.addEventListener('click', e => {
    playSFX(1);
    onA(e);
    })
  );
bBtns.forEach(x => 
  x.addEventListener('click', e => {
    playSFX(1);
    onB(e);
    })
  );

sendBtn.addEventListener('click', () => {
  playSFX(3);
  send();
});

sel.addEventListener('change', () => {
  playSFX(2);
});

/* ===== 啟動 ===== */
setSel(aBtns, selA, 'a');
setSel(bBtns, selB, 'b');
enableSend();
fillDateSelect();
el.value=loadA();
renderB(DRAFTB);
probeStatus();
startClock();
setInterval(startClock,1000);
checkCutoff();
setInterval(checkCutoff, 5 * 60 * 1000);
</script>
</body>
</html>